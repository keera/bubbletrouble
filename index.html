<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
    <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="css/normalize.min.css">
        <link rel="stylesheet" href="css/main.css">
        <style type="text/css">
            canvas {
                border: 1px solid #000;
            }
        </style>
    </head>
    <body>
        <!--[if lt IE 7]>
        <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->
        <canvas id="tutorial" width="300" height="150"></canvas>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.1.min.js"><\/script>')</script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
          var canvas = document.getElementById('tutorial');
          var ctx = null;
          var x = canvas.width / 2;
          var y = canvas.height / 2;
          var radius = 16;
          var ball = null;
          var balls = [];
          var players = {};
          var person = null;
          var spears = [];

          //init the context (needs to exist before naything)
          function drawBall(ball, ctx) {
            ctx.beginPath();
            ctx.fillStyle = "black";
            ctx.arc(ball.x, ball.y, ball.radius, 0, 2 * Math.PI, true);
            ctx.closePath();
            ctx.fill();
          }

          function init() {
            if(canvas.getContext) {
              ctx = canvas.getContext('2d');
            }
            return setInterval(draw, 10);
          }

          /**
           * Weapon that breaks balls
           */
          function Spear(ctx, myDot, startTime, cfg) {
            this.ctx = ctx;
            this.ownerId = cfg.ownerId || 1;
            this.startTime = cfg.startTime || startTime;
            this.animateSpear = cfg.animateSpear || false;
            this.lineStartTime = cfg.lineStartTime || null;
            this.lineLifeTime = cfg.lineLifeTime || 1500; // ms
            this.myDot = cfg.myDot || myDot;
            this.tipIndex = cfg.tipIndex || 0;
            this.isSolid = cfg.isSolid || false;
            this.history = cfg.history || {
              x : [],
              y : []
            };
          }

          Spear.prototype.drawSpear = function(myDot, context) {
            for(var i = 0; i < this.history.x.length; i++) {
              // Draw the tip as a triangle
              if(i == this.history.x.length - 1) {
                context.beginPath();
                context.moveTo(this.history.x[i] - 3, this.history.y[i] - 5);
                context.lineTo(this.history.x[i], this.history.y[i] - 10);
                context.lineTo(this.history.x[i] + 3, this.history.y[i] - 5);
                context.lineJoin = 'miter';
                context.stroke();
              }
              context.fillRect(this.history.x[i], this.history.y[i], 1, 1);
            }
          }

          // If the oscillation is at ceil
          Spear.prototype.atCeil = function() {
            return (this.myDot.y <= 0);
          }

          Spear.prototype.clearSpear = function(context) {
            for(var i = 0; i < this.history.x.length; i++) {
              context.clearRect(this.history.x[i], this.history.y[i], 1, 1);
            }
          }

          Spear.prototype.drawLine = function(timeNow) {
            // Start the solid
            if(!this.lineStartTime) {
              this.lineStartTime = timeNow;
              this.isSolid = true;
            }
            this.ctx.beginPath();
            this.ctx.moveTo(this.history.x[0], this.history.y[0]);
            this.ctx.lineTo(this.history.x[0], 0);
            this.ctx.stroke();
            
            // Kill solid line after 1000 ms
            if(timeNow - this.lineStartTime > this.lineLifeTime) {
              this.resetLine();
            }
            
          }

          Spear.prototype.resetLine = function() {
            this.lineStartTime = null;
            this.isSolid = false;
            // Reset tip
            this.myDot.y = canvas.height;
            // Empty history
            this.history.x = [];
            this.history.y = [];
            this.animateSpear = false;
          }

          Spear.prototype.animate = function() {
            if(!this.animateSpear) return;
            // if we reach the top
            if(this.atCeil()) {
              this.clearSpear(this.ctx);
              //draw solid line. Keep for N ms
              var timeNow = (new Date()).getTime();
              this.drawLine(timeNow);
              return;
            }
            
            // If first call, use persons location
            // This needs to be changed to use the player it belongs to
            // hard code for now
            if(this.history.x.length == 0) {
              this.myDot.x = players[this.ownerId].x + 5; // we should add it by 1/2 width of person
              this.myDot.y = players[this.ownerId].y + 10; // Start from feet
            }
            this.history.x.push(this.myDot.x);
            this.history.y.push(this.myDot.y);

            // Update tip location
            this.tipIndex = this.history.x.length - 1;
            
            var time = (new Date()).getTime() - this.startTime;
            var amplitude = 3;
            // In ms
            var period = 100;
            var centerX = this.history.x[0];
            var nextX = amplitude * Math.sin(time * 2 * Math.PI / period) + centerX;
            // Set new location of dot
            this.myDot.x = nextX;
            this.myDot.y -= 2;
            // Draw series of dots
            this.ctx.fillStyle = "red";
            this.drawSpear(this.myDot, this.ctx);
          }

          /**
           * The player
           */
          function Person(x, y, ctx, cfg) {
            this.color = cfg.color || 'blue';
            this.x = cfg.x || x;
            this.dx = cfg.dx || 4;
            this.direction = cfg.direction || null;
            this.dy = cfg.dy || 4;
            this.y = cfg.y || y;
            this.ctx = ctx;
          }

          Person.prototype.draw = function() {
            this.ctx.beginPath();
            this.ctx.fillStyle = this.color;
            this.ctx.rect(this.x, this.y, 10, 10);
            this.ctx.closePath();
            this.ctx.fill();
          }

          Person.prototype.moveLeft = function() {
            this.x = (this.x <= 0) ? this.x : this.x - this.dx;
          }

          Person.prototype.moveRight = function() {
            this.x = ((this.x + 10) >= canvas.width) ? this.x : this.x + this.dx;
          }

          /**
           * The ball
           */
          function Ball(x, y, radius, dy, initDirection, ctx, cfg) {
            this.x = cfg.x || x;
            // x location
            this.y = cfg.y || y;
            // location
            this.dx = cfg.dx || (initDirection == 'right') ? 1 : -1;
            // x velocity
            this.dy = cfg.dy || 0;
            // y velocity
            this.gravity = cfg.gravity || 0.1;
            this.xdirection = cfg.xdirection || 0.8;
            this.splitStatus = cfg.splitStatus || false;
            // Direction y
            this.ydirection = cfg.ydirection || 1;
            this.radius = cfg.radius || radius;
            this.ctx = ctx;
          }

          Ball.prototype.draw = function() {
            this.ctx.beginPath();
            this.ctx.fillStyle = "black";
            this.ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, true);
            this.ctx.closePath();
            this.ctx.fill();
          }

          Ball.prototype.move = function() {
            this.hasCollided();
            this.dy += this.gravity;

            this.x += this.dx * this.xdirection;
            this.y += this.dy * this.ydirection;
          }

          Ball.prototype.hasCollided = function() {
            // Bounce off ground
            if(this.y + this.radius > canvas.height) {
              this.ydirection = -this.ydirection;
              this.dy += this.gravity;
              // Add increase again so next call
              // gets reduced by same amt (symmetry)
              // ie: 1, 2, 3, 3, 2, 1
              this.gravity = -this.gravity;
              //reverse gravity
            }

            // Bounce off walls
            if(this.x + this.radius > canvas.width || this.x + this.radius < 0) {
              this.xdirection = -this.xdirection;
            }

          }

          // Animation loop
          function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for(var i in players) {
              players[i].draw();
            }
            for(var i = 0; i < balls.length; i++) {
              balls[i].draw();
              balls[i].move();
            }
            for(var i = 0; i < spears.length; i++) {
              spears[i].animate();
            }
          }

          // Listeners
          $(document).keypress(function(event) {
            if(event.charCode == 32) {
              socket.emit('fireSpear');
            }
          });

          $(document).keydown(function(event) {
            if(event.which == 65) {
              players[socket.socket.sessionid].moveLeft();
              console.log("Move left");
              socket.emit('personMoveLeft');
            }
            if(event.which == 68) {
              players[socket.socket.sessionid].moveRight();
              console.log("Move right");
              socket.emit('personMoveRight');
            }
          });

          init();

          function update(newBalls) {
            balls = [];
            for(var i in newBalls) {
              var ballData = newBalls[i];
              var direction = (ballData.dx > 0) ? 'right' : 'left';
              var config = {
                x: ballData.x,
                y: ballData.y,
                dx: ballData.dx,
                dy: ballData.dy,
                gravity: ballData.gravity,
                xdirection: ballData.xdirection,
                splitstatus: ballData.splitstatus,
                ydirection: ballData.ydirection,
                radius: ballData.radius,
              };
              var newBall = new Ball(ballData.x, ballData.y, ballData.radius, ballData.dy, direction, ctx, config);
            balls.push(newBall);
          }
         }

         function updatePlayerPos(newPlayers) {
            console.log("Update player position");
            players = {};
            for(var i in newPlayers) {
              var playerData = newPlayers[i];
              var config = {
                x: playerData.x,
                y: playerData.y,
                dx: playerData.dx,
                color: playerData.color,
                }
                console.log("Creating player with color " + playerData.color);
              var newPlayer = new Person(0, 0, ctx, config);
              players[i] = newPlayer;
              }
            console.log("After adding players");
            console.log(players);
          }

          function updateSpears(newSpears) {
            // this should actually come back with the id
            console.log("Update player position");
            spears = [];
            for (var i in newSpears) {
              var spearData = newSpears[i];
              var config = {
                startTime : spearData.startTime,
                animateSpear : spearData.animateSpear,
                lineStartTime : spearData.lineStartTime,
                lineLifeTime : spearData.lineLifeTime,
                myDot : spearData.myDot,
                tipIndex : spearData.tipIndex,
                isSolid : spearData.isSolid,
                history : spearData.history,
                ownerId : i,
              }
              var newSpear = new Spear(ctx, 0, 0, config);
              spears.push(newSpear);
            }
          }

          var socket = io.connect('http://localhost');

          // Connect on handshake
          socket.on('acknowledge', function(data) {
            console.log("Connected");
            socket.emit('joinGame');
          });
          socket.on('updateGame', function(data) {
            update(data.balls);
            updatePlayerPos(data.players);
          });
          socket.on('updatePlayerPos', function(data) {
            updatePlayerPos(data.players);
          });
          socket.on('updateSpear', function(data) {
            updateSpears(data.spears);
          });
          socket.on('updateBalls', function(data) {
            update(data.balls);
          });
        </script>
        <script>
          var _gaq = [['_setAccount', 'UA-XXXXX-X'], ['_trackPageview']];
          ( function(d, t) {
            var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
            g.src = '//www.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g, s)
          }(document, 'script'));

        </script>
    </body>
</html>
