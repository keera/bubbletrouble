<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
    <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="css/normalize.min.css">
        <link rel="stylesheet" href="css/main.css">
        <style type="text/css">
          body {
            background-color:black; 
          }
          #help {
            margin-top: 50px;
            margin-left:60px;
          }
          #help h1 {
            font-weight: bold;
            width: 100px;
            font-size: 16px;
            border-bottom: solid 1px #000;
          }
          canvas {
                position: absolute;
                margin-left: 50px;
                border-top-width: 4px;
                border-bottom-width: 4px;
                border-top-style: double;
                border-bottom-style: double;
                border-top-color: #E1A60A;
                border-bottom-color: #E1A60A;
                padding: 8px 0px;
            }

          #background {
            z-index: -2;
          }
          #main {
            z-index: -1;
          }
          #scoreboard {
            z-index: 0;
          }
        </style>
    </head>
    <body>
        <!--[if lt IE 7]>
        <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->
        <h1>Bubble Trouble</h1>
        <canvas id="main" width="1000" height="400"></canvas>
        <canvas id="background" width="1000" height="400"></canvas>
        <canvas id="scoreboard" width="1000" height="400"></canvas>
        <audio id="soundEfx" src="sounds/pop.wav" style="display: none;"></audio>
        <audio id="gunSoundEfx" src="sounds/gun.wav" style="display: none;"></audio>
        <audio autoplay loop id="bgSound" src="sounds/dst.mp3" style="display: none;"></audio>
        <div id="help">
          <h1>Controls</h1>
          <p>W - Left | D - Right</p>
          <p>Spacebar - Shoot</p>
        </div>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.1.min.js"><\/script>')</script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
          window.requestAnimFrame = (function(){
            return  window.requestAnimationFrame ||
              window.webkitRequestAnimationFrame ||
              window.mozRequestAnimationFrame    ||
              window.oRequestAnimationFrame      ||
              window.msRequestAnimationFrame     ||
              function(/* function */ callback, /* DOMElement */ element){
                window.setTimeout(callback, 1000 / 60);
              };
          })();

          var canvas = document.getElementById('main');
          var bg = document.getElementById('background');
          var scoreboard = document.getElementById('scoreboard');
          var soundEfx = document.getElementById("soundEfx");
          var gunSoundEfx = document.getElementById("gunSoundEfx");
          var ctx = null;
          var x = canvas.width / 2;
          var y = canvas.height / 2;
          var playerImg = new Image();
          playerImg.src = 'images/pang.png';
          var playerImgReverse = new Image();
          playerImgReverse.src = 'images/pangleft.png';
          var radius = 16;
          var ball = null;
          var balls = {};
          var players = {};
          var person = null;
          var spears = {};

          //init the context (needs to exist before naything)
          function drawBall(ball, ctx) {
            ctx.beginPath();
            ctx.fillStyle = "black";
            ctx.arc(ball.x, ball.y, ball.radius, 0, 2 * Math.PI, true);
            ctx.closePath();
            ctx.fill();
          }

          function init() {
            if(canvas.getContext) {
              ctx = canvas.getContext('2d');
            }
            var background = document.getElementById('background');
            var context = background.getContext('2d');
            var imageObj = new Image();
            imageObj.onload = function() {
              context.drawImage(imageObj, 0, 0);
            }
            //imageObj.src = 'http://fc01.deviantart.net/fs71/f/2012/011/4/8/background_for_flash_game_by_pykodelbi-d4ly9hx.jpg';
            imageObj.src = 'images/buildings.jpg';
          }

          function animate() {
            requestAnimFrame( animate );
            draw();
          }

          /**
           * Weapon that breaks balls
           */
          function Spear(ctx, myDot, startTime, cfg) {
            this.ctx = ctx;
            this.ownerId = cfg.ownerId || 1;
            this.startTime = cfg.startTime;
            this.currentTime = (new Date()).getTime();
            this.accum = 0;
            this.period = cfg.period || 100;
            this.dy = cfg.dy || 1;
            this.amplitude = cfg.amplitude || 10;
            this.animateSpear = cfg.animateSpear || false;
            this.lineStartTime = cfg.lineStartTime || null;
            this.lineLifeTime = cfg.lineLifeTime || 1500; // ms
            this.myDot = cfg.myDot || myDot;
            this.tipIndex = cfg.tipIndex || 0;
            this.isSolid = cfg.isSolid || false;
            this.history = cfg.history || {
              x : [],
              y : []
            };
          }

          Spear.prototype.draw = function() {
            if(this.isSolid) {
                this.ctx.beginPath();
                this.ctx.moveTo(this.history.x[0], this.history.y[0]);
                this.ctx.lineTo(this.history.x[0], 0);
                this.ctx.strokeStyle = "white";
                this.ctx.stroke();
            } else {
            // Draw the tip as a triangle
              var tipIndex = this.history.x.length - 1;
              this.ctx.beginPath();
              this.ctx.moveTo(this.history.x[tipIndex] - 3, this.history.y[tipIndex] - 2);
              this.ctx.lineTo(this.history.x[tipIndex], this.history.y[tipIndex] - 10);
              this.ctx.lineTo(this.history.x[tipIndex] + 3, this.history.y[tipIndex] - 2);
              //this.ctx.closePath();
              this.ctx.lineJoin = 'miter';

              this.ctx.lineWidth = 2;
              //this.ctx.fillStyle = 'red';
              //this.ctx.fill();
              this.ctx.strokeStyle = 'red';
              this.ctx.stroke();

              this.ctx.fillStyle = "red";
              for(var i = 0; i < this.history.x.length; i++) {
                this.ctx.fillRect(this.history.x[i], this.history.y[i], 2, 2);
              }
            }
          }

          // If the oscillation is at ceil
          Spear.prototype.atCeil = function() {
            return (this.myDot.y <= 0);
        }

            Spear.prototype.updateState = function(cfg) {
                this.ctx = ctx;
                this.ownerId = cfg.ownerId || 1;
                this.period = cfg.period || 100;
                this.dy = cfg.dy || 1;
                this.amplitude = cfg.amplitude || 10;
                this.animateSpear = cfg.animateSpear || false;
                this.lineStartTime = cfg.lineStartTime || null;
                this.lineLifeTime = cfg.lineLifeTime || 1500; // ms
                this.myDot = cfg.myDot || myDot;
                this.tipIndex = cfg.tipIndex || 0;
                this.isSolid = cfg.isSolid || false;
                this.history = cfg.history || {
                x : [],
                y : []
                };
            }

          Spear.prototype.resetLine = function() {
            this.lineStartTime = null;
            this.isSolid = false;
            // Reset tip
            this.myDot.y = canvas.height;
            // Empty history
            this.history.x = [];
            this.history.y = [];
            this.animateSpear = false;
          }

          Spear.prototype.update = function(delta) {
            if(!this.animateSpear) return;

            if(this.atCeil()) {
              //draw solid line. Keep for N ms
              var timeNow = (new Date()).getTime();
              if(!this.lineStartTime) {
                this.lineStartTime = timeNow;
                this.isSolid = true;
                this.lineMode = true;
              }
              if(timeNow - this.lineStartTime > this.lineLifeTime) {
                this.resetLine();
               }
              return;
            }
            // If first call, use persons location
            // This needs to be changed to use the player it belongs to
            // hard code for now
            if(this.history.x.length == 0) {
              this.myDot.x = players[this.ownerId].x + 10; // we should add it by 1/2 width of person
              this.myDot.y = players[this.ownerId].y + 20; // Start from feet
            }
            this.history.x.push(this.myDot.x);
            this.history.y.push(this.myDot.y);

            // Update tip location
            this.tipIndex = this.history.x.length - 1;
            var time = (new Date()).getTime() - this.startTime;
            var amplitude = this.amplitude;
            // In ms
            var period = this.period;
            var centerX = this.history.x[0];
            var nextX = amplitude * Math.sin(time * 2 * Math.PI / period) + centerX;
            // Set new location of dot
            this.myDot.x = nextX;
            this.myDot.y -= this.dy * delta;
            // Draw series of dots
          }

          /**
           * The player
           */
          function Person(x, y, ctx, cfg) {
            this.color = cfg.color || 'blue';
            this.x = cfg.x || x;
            this.dx = cfg.dx || 4;
            this.direction = cfg.direction || null;
            this.dy = cfg.dy || 4;
            this.y = cfg.y || y;
            this.ctx = ctx;
            this.spriteStart = null;
            this.knockedLeft;
            this.knockedRight;
            this.hurt;
            this.walkIndex = 0;
            this.movingRight = cfg.movingRight;
            this.moving = false;
            this.firedSpear = cfg.firedSpear;
            this.stationary = false;
            // Right frames
            this.frames = [
              {x: 10},
              {x: 10 + 32 + 5},
              {x: 10 + 32 + 32 + 5},
              {x: 10 + 32 + 32 + 32 + 5},
              {x: 10 + 32 + 32 + 32 + 32 + 10},
            ];

            this.leftFrames = [
              {x: 353},
              {x: 353 - 32},
              {x: 353 - 32 - 32},
              {x: 353 - 32 - 32 - 32 - 5},
              {x: 353 - 32 - 32 - 32 - 32 - 8},
            ];
            this.frameInterval = 500;
            }

          Person.prototype.startMoving = function() {
            this.moving = true;
            if(!this.spriteStart) {
              this.spriteStart = (new Date()).getTime();
            }
          }

          Person.prototype.stopMoving = function() {
            this.moving = false;
            this.spriteStart = null;
            this.walkIndex = 0;
            }

          Person.prototype.isMoving = function () {
            return this.moving;
          }

          Person.prototype.draw = function() {
          //if time is still within bounds of current animation, stay.
          // else, move on.
            if(this.firedSpear) {
              ctx.drawImage(playerImg, 43 , 110, 32, 32, this.x, this.y - 13, 32, 32);
              return;
            }
            if (this.isMoving()) {
              var timeNow = (new Date()).getTime();
              if (timeNow - this.spriteStart >= this.frameInterval) {
                this.walkIndex = (this.walkIndex + 1) % 5;
              }
              if(this.movingRight) {
                ctx.drawImage(playerImg, this.frames[this.walkIndex].x , 0, 32, 32, this.x, this.y - 13, 32, 32);
              } else {
                //console.log("MOVING LEFT");
                ctx.drawImage(playerImgReverse, this.leftFrames[this.walkIndex].x , 0, 32, 32, this.x, this.y - 13, 32, 32);
              }
            } else {
              if(this.movingRight)
                ctx.drawImage(playerImg, 10 , 110, 32, 32, this.x, this.y - 13, 32, 32);
              else
                ctx.drawImage(playerImgReverse, 357 , 110, 32, 32, this.x, this.y - 13, 32, 32);
            }
            /*this.ctx.beginPath();
            this.ctx.fillStyle = this.color;
            this.ctx.rect(this.x, this.y, 20, 20);
            this.ctx.closePath();
            this.ctx.fill();*/
          }

          Person.prototype.moveLeft = function() {
          this.movingRight = false;
          this.firedSpear = false;
            this.x = (this.x <= 0) ? this.x : this.x - this.dx;
          }

          Person.prototype.moveRight = function() {
            this.movingRight = true;
          this.firedSpear = false;
            this.x = ((this.x + 10) >= canvas.width) ? this.x : this.x + this.dx;
          }

          /**
           * The ball
           */
          function Ball(x, y, radius, dy, initDirection, ctx, cfg) {
            this.x = cfg.x || x;
            this.accum = 0;
            // x location
            this.y = cfg.y || y;
            this.color = cfg.color || '#E00000';
            this.currentTime = (new Date()).getTime();
            // location
            this.dx = cfg.dx;
            // x velocity
            this.dy = cfg.dy || 0;
            // y velocity
            this.gravity = cfg.gravity || 0.1;
            this.xdirection = cfg.xdirection || 0.8;
            this.splitStatus = cfg.splitStatus || false;
            // Direction y
            this.ydirection = cfg.ydirection || 1;
            this.radius = cfg.radius || radius;
            this.ctx = ctx;
          }

          Ball.prototype.draw = function() {
            this.ctx.beginPath();
            this.ctx.fillStyle = this.color;
            this.ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, true);
            this.ctx.closePath();
            this.ctx.fill();
            this.ctx.lineWidth = 3;
            this.ctx.strokeStyle = "black";
            this.ctx.stroke();
          }

          /*Ball.prototype.move = function() {
            this.hasCollided();
            this.dy += this.gravity;

            this.x += this.dx * this.xdirection;
            this.y += this.dy * this.ydirection;
          }*/

          Ball.prototype.move = function(delta) {
            this.hasCollided();
            this.dy += this.gravity;
            this.x += this.dx * this.xdirection * delta;
            this.y += this.dy * this.ydirection * delta;
          }

          Ball.prototype.hasCollided = function() {
            // Bounce off ground
            if(this.y + this.radius > canvas.height) {
              this.ydirection = -this.ydirection;
              this.dy += this.gravity;
              // Add increase again so next call
              // gets reduced by same amt (symmetry)
              // ie: 1, 2, 3, 3, 2, 1
              this.gravity = -this.gravity;
              //reverse gravity
            }

            // Bounce off walls
            if(this.x + this.radius > canvas.width || this.x + this.radius < 0) {
              this.xdirection = -this.xdirection;
            }

          }

          // Animation loop
/*          function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for(var i in players) {
              players[i].draw();
            }
            for(var i = 0; i < balls.length; i++) {
              balls[i].draw();
              //balls[i].move();
            }
            for(var i in spears) {
              spears[i].animate();
            }
        }*/

          var currentTime = (new Date()).getTime();
          var dt = 1/60; // frames per second.
          var accumulator = 0;

          function updateBallPhysics(timeUpdate) {
            // update physics
            var timeNow = timeUpdate || (new Date()).getTime();
            var delta = (timeNow - currentTime) / 1000; //convert to seconds
            currentTime = timeNow;
            accumulator += delta;
            while (accumulator >= dt){
                accumulator -= dt;
                for (var i in balls) {
                    balls[i].move(dt);
                }
            }
          }
          //what carries over
          // update ball physics
          function updateBallPhysicsTwo(timeUpdate) {
            var timeNow = timeUpdate || (new Date()).getTime();
            for(var i in balls) {
                var delta = (timeNow - balls[i].currentTime) / 1000; //convert to seconds
                balls[i].currentTime = timeNow;
                balls[i].accum += delta;
                while (balls[i].accum >= dt){
                    balls[i].accum -= dt;
                    balls[i].move(dt);
                }
            }
            for(var i in spears) {
                var delta = (timeNow - spears[i].currentTime) / 1000; //convert to seconds
                spears[i].currentTime = timeNow;
                spears[i].accum += delta;
                while (spears[i].accum >= dt){
                    spears[i].accum -= dt;
                    spears[i].update(dt);
                }
            }
          }

          function updateBallPosition(i, x, y) {
            balls[i].x = x;
            balls[i].y = y;
          }

          function updateSingleBallPhysics(i, timeUpdate) {
            // update physics
            var timeNow = timeUpdate || (new Date()).getTime();
            var delta = (timeNow - currentTime) / 1000; //convert to seconds
            currentTime = timeNow;
            accumulator += delta;
            while (accumulator >= dt){
              accumulator -= dt;
              balls[i].move(dt);
            }
          }

          

          function draw() {
            updateBallPhysicsTwo();
            // now render the actual display
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for(var i in players) {
              players[i].draw();
            }
            for(var i in balls) {
              balls[i].draw();
            }
            for(var i in spears) {
              spears[i].draw();
            }
          }

          var keyboard = {
            SPACE: 32,
            W: 65,
            D: 68,
            L: 108,
          }

          // Listeners
          $(document).keypress(function(event) {
            if(event.charCode == keyboard.L) {
              socket.emit('addBall');
            }

            if(event.charCode == keyboard.SPACE) {
              socket.emit('fireSpear');
              gunSoundEfx.load();
              gunSoundEfx.play();
              players[socket.socket.sessionid].firedSpear = true;
            }
          });

          $(document).keydown(function(event) {
            if(event.which == keyboard.W) {
              players[socket.socket.sessionid].startMoving();
              players[socket.socket.sessionid].moveLeft();
              console.log("Move left");
              socket.emit('personMoveLeft');
            }
            if(event.which == keyboard.D) {
              players[socket.socket.sessionid].startMoving();
              players[socket.socket.sessionid].moveRight();
              console.log("Move right");
              socket.emit('personMoveRight');
            }
          });

          $(document).keyup(function(event) {
            if(event.which == keyboard.W) {
              players[socket.socket.sessionid].stopMoving();
            }
            if(event.which == keyboard.D) {
              players[socket.socket.sessionid].stopMoving();
            }
          });


          init();
          animate();
          function getBallColor(size) {
            if(size >= 32) {
              return 'red';
            } else if (size >= 16) {
              return 'blue';
            } else if (size >= 8) {
              return 'yellow';
            } else {
              return 'green';
            }
          }
          function updateBalls(newBalls) {
          // doesnt account for deleted balls
          // reset the time
            for(var i in balls) {
              if(!newBalls[i]) delete balls[i];
            }
            for(var i in newBalls) {
            // if we do not have the local ball
            // later we must account for latency
              var ballData = newBalls[i];
              if(!balls[i]) {
                var config = {
                  x: ballData.x,
                  y: ballData.y,
                  dx: ballData.dx,
                  dy: ballData.dy,
                  color: getBallColor(ballData.radius),
                  gravity: ballData.gravity,
                  xdirection: ballData.xdirection,
                  splitstatus: ballData.splitstatus,
                  ydirection: ballData.ydirection,
                  radius: ballData.radius,
                  };
                var newBall = new Ball(ballData.x, ballData.y, ballData.radius, ballData.dy, 'right', ctx, config);
                balls[i] = newBall;
              } 
            }
         }
        // TODO:: refactor to not create new player object..
         function updatePlayerPos(newPlayers) {
            players = {};
            for(var i in newPlayers) {
            var playerData = newPlayers[i];
              var config = {
                x: playerData.x,
                y: playerData.y,
                dx: playerData.dx,
                firedSpear: playerData.firedSpear,
                movingRight: playerData.movingRight,
                color: playerData.color,
                }
              var newPlayer = new Person(0, 0, ctx, config);
              players[i] = newPlayer;
              }
          }

          function updateSpears(newSpears) {
            // this should actually come back with the id
            for (var i in newSpears) {
              var spearData = newSpears[i];
              var config = {
                startTime : spearData.startTime,
                animateSpear : spearData.animateSpear,
                lineStartTime : spearData.lineStartTime,
                lineLifeTime : spearData.lineLifeTime,
                dy: spearData.dy,
                amplitude: spearData.amplitude,
                period: spearData.period,
                myDot : spearData.myDot,
                tipIndex : spearData.tipIndex,
                isSolid : spearData.isSolid,
                history : spearData.history,
                ownerId : i,
            }
            if(!spears[i]) {
              var newSpear = new Spear(ctx, 0, 0, config);
              spears[i] = newSpear;
              } else {
              spears[i].updateState(config);
          }
              }
      }

          var socket = io.connect('http://localhost');

          // Connect on handshake
          socket.on('acknowledge', function(data) {
            console.log("Connected");
            socket.emit('joinGame');
          });

          socket.on('firstUpdate', function(data) {
            // On first receive, set the currenttime to time of receipt
            //currentTime = (new Date()).getTime();
            updateBalls(data.balls);
            updatePlayerPos(data.players);
            updateSpears(data.spears);
          });

          socket.on('gameFull', function(data) {
            alert("Sorry, the game is full :)");
          });

          socket.on('updateGame', function(data) {
            update(data.balls);
            updatePlayerPos(data.players);
          });

          socket.on('updatePlayerPos', function(data) {
            updatePlayerPos(data.players);
          });

          socket.on('updateSpear', function(data) {
            updateSpears(data.spears);
          });

          socket.on('updateBalls', function(data) {
            soundEfx.load();
            soundEfx.play();
            updateBalls(data.balls);
          });

          socket.on('collide', function(data) {
            updateBalls(data.balls);
          });

        </script>
        <script>
          var _gaq = [['_setAccount', 'UA-XXXXX-X'], ['_trackPageview']];
          ( function(d, t) {
            var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
            g.src = '//www.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g, s)
          }(document, 'script'));

        </script>
    </body>
</html>
